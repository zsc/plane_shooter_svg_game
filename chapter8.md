# 第8章：武器系统

## 概述

武器系统是飞机大战游戏的核心战斗机制，负责管理玩家和敌机的所有攻击手段。本章详细定义了武器类型、升级机制、特殊武器设计以及弹幕生成算法，为游戏提供丰富多样的战斗体验。

### 设计原则
- **易于上手**：基础武器简单直观，新玩家可快速掌握
- **深度策略**：不同武器组合适应不同战斗场景
- **视觉反馈**：清晰的弹道轨迹和命中效果
- **性能优化**：高效的对象池管理和碰撞检测

### 系统架构
```
武器系统
├── 武器管理器 (WeaponManager)
│   ├── 武器实例池
│   ├── 弹药对象池
│   └── 升级状态机
├── 弹道引擎 (BallisticsEngine)
│   ├── 轨迹计算器
│   ├── 弹幕生成器
│   └── 碰撞检测器
└── 特效系统 (EffectsSystem)
    ├── 发射特效
    ├── 命中特效
    └── 爆炸特效
```

## 8.1 基础武器类型

### 8.1.1 主武器系统

#### 机枪 (Machine Gun)
**基础属性**
- 攻击力：10-15点
- 射速：10发/秒
- 弹道：直线
- 穿透：无
- 能量消耗：0

**特性描述**
- 最基础的武器，无限弹药
- 适合对付小型敌机
- 升级后可增加发射角度和子弹数量

**升级路径**
1. 等级1：单发直射
2. 等级2：双发平行
3. 等级3：三发扇形（15°夹角）
4. 等级4：五发扇形（30°夹角）
5. 等级5：七发扇形 + 增加射速

#### 激光炮 (Laser Cannon)
**基础属性**
- 攻击力：50-75点
- 射速：2发/秒
- 弹道：直线贯穿
- 穿透：可穿透3个目标
- 能量消耗：10点/发

**特性描述**
- 高伤害穿透武器
- 适合对付排列密集的敌机
- 需要能量支持，过热会暂停发射

**升级路径**
1. 等级1：细激光束（1像素宽）
2. 等级2：标准激光束（3像素宽）
3. 等级3：粗激光束（5像素宽）+ 增加穿透
4. 等级4：双激光束平行发射
5. 等级5：三叉激光 + 持续伤害效果

#### 导弹发射器 (Missile Launcher)
**基础属性**
- 攻击力：100-150点
- 射速：1发/秒
- 弹道：追踪
- 穿透：无（范围爆炸）
- 能量消耗：20点/发

**特性描述**
- 自动追踪最近敌机
- 爆炸造成范围伤害
- 适合对付大型目标和Boss

**升级路径**
1. 等级1：单发追踪导弹
2. 等级2：双发导弹（左右交替）
3. 等级3：增加爆炸范围
4. 等级4：分裂导弹（命中后分裂）
5. 等级5：集束导弹 + 二次锁定

### 8.1.2 副武器系统

#### 散弹枪 (Shotgun)
**基础属性**
- 攻击力：8点×5发
- 射速：3发/秒
- 弹道：扇形散射
- 有效射程：屏幕高度的40%
- 特殊：近距离伤害加成

**应用场景**
- 近距离清屏
- 对付冲撞型敌机
- 紧急防御手段

#### 电浆炮 (Plasma Cannon)
**基础属性**
- 攻击力：30-40点
- 射速：5发/秒
- 弹道：抛物线
- 特殊：溅射伤害
- 充能时间：0.5秒

**应用场景**
- 中距离输出
- 对付密集编队
- 需要预判弹道

#### 脉冲波 (Pulse Wave)
**基础属性**
- 攻击力：20点
- 射速：持续输出
- 弹道：扇形波纹扩散
- 范围：120°扇形
- 特殊：击退效果

**应用场景**
- 防御型武器
- 清理弹幕
- 保护侧翼

### 8.1.3 武器属性表

| 武器类型 | 基础伤害 | 射速 | 弹速 | 穿透 | 能耗 | 特殊效果 |
|---------|---------|------|------|------|------|---------|
| 机枪 | 10 | 10/s | 800px/s | 0 | 0 | 无 |
| 激光炮 | 50 | 2/s | 即时 | 3 | 10 | 穿透 |
| 导弹 | 100 | 1/s | 400px/s | 0 | 20 | 追踪+爆炸 |
| 散弹枪 | 8×5 | 3/s | 600px/s | 0 | 5 | 扇形散射 |
| 电浆炮 | 35 | 5/s | 500px/s | 0 | 8 | 溅射 |
| 脉冲波 | 20 | 持续 | 300px/s | ∞ | 15/s | 击退 |

## 8.2 武器升级树

### 8.2.1 升级系统架构

#### 升级路径类型
1. **线性升级**：按顺序逐级提升
2. **分支升级**：可选择不同发展方向
3. **组合升级**：多种武器融合形成新武器

#### 升级资源
- **能量核心**：提升武器等级
- **改造零件**：解锁特殊属性
- **稀有材料**：开启分支路径

### 8.2.2 机枪升级树

```
机枪 Lv.1
    │
    ├─→ 速射路线
    │   ├─ Lv.2: 射速+20%
    │   ├─ Lv.3: 射速+40% + 过热保护
    │   ├─ Lv.4: 射速+60% + 冷却加速
    │   └─ Lv.5: 极速机枪（20发/秒）
    │
    ├─→ 散射路线
    │   ├─ Lv.2: 双管平行
    │   ├─ Lv.3: 三管扇形
    │   ├─ Lv.4: 五管扇形 + 子弹尺寸+50%
    │   └─ Lv.5: 全屏弹幕（180°覆盖）
    │
    └─→ 穿透路线
        ├─ Lv.2: 穿透1个目标
        ├─ Lv.3: 穿透2个目标 + 伤害递减50%
        ├─ Lv.4: 穿透3个目标 + 附加燃烧
        └─ Lv.5: 贯穿激光枪（直线贯穿）
```

### 8.2.3 导弹升级树

```
导弹 Lv.1
    │
    ├─→ 追踪强化
    │   ├─ Lv.2: 转向速度+50%
    │   ├─ Lv.3: 智能避障
    │   ├─ Lv.4: 多目标锁定（3个）
    │   └─ Lv.5: 量子锁定（必中）
    │
    ├─→ 爆炸强化
    │   ├─ Lv.2: 爆炸范围+30%
    │   ├─ Lv.3: 连锁爆炸
    │   ├─ Lv.4: 震荡波（二次伤害）
    │   └─ Lv.5: 核爆导弹（全屏伤害）
    │
    └─→ 分裂路线
        ├─ Lv.2: 命中后分裂2枚
        ├─ Lv.3: 空中分裂（定时）
        ├─ Lv.4: 递归分裂（二次分裂）
        └─ Lv.5: 蜂群导弹（分裂8枚）
```

### 8.2.4 组合武器

#### 融合规则
- 需要两种武器都达到Lv.3以上
- 消耗特殊融合材料
- 融合后保留两种武器特性

#### 融合武器示例

**电磁轨道炮**（激光炮 + 机枪）
- 结合激光的穿透和机枪的连射
- 发射带电粒子流
- 命中后产生电磁场持续伤害

**等离子导弹**（导弹 + 电浆炮）
- 导弹爆炸后释放等离子云
- 持续区域伤害
- 减速经过的敌机

**聚能散弹**（散弹枪 + 激光炮）
- 发射能量弹丸扇形散射
- 短距离内可聚合成激光束
- 远距离保持散射效果

## 8.3 特殊武器设计

### 8.3.1 必杀技系统

#### 触发条件
- 收集满能量槽（100点）
- 或拾取必杀技道具
- 冷却时间：30秒

#### 必杀技类型

**轨道轰炸**
- 效果：从屏幕顶部召唤卫星激光扫射
- 持续时间：3秒
- 伤害：200点/秒
- 覆盖范围：全屏幕垂直扫描

**时间冻结**
- 效果：减缓所有敌机和子弹速度至10%
- 持续时间：5秒
- 附加效果：玩家攻击力+100%
- 视觉效果：黑白滤镜 + 残影

**超级护盾**
- 效果：生成反弹护盾
- 持续时间：8秒
- 特殊：反弹所有子弹并造成伤害
- 视觉效果：能量护罩 + 波纹扩散

### 8.3.2 充能武器

#### 充能机制
- 长按射击键进行充能
- 充能时移动速度降低30%
- 分为3个充能阶段

#### 充能武器示例

**充能激光**
- 阶段1（0.5秒）：标准激光
- 阶段2（1.5秒）：粗激光 + 穿透
- 阶段3（3秒）：巨型激光柱，全屏穿透

**充能导弹**
- 阶段1：单发导弹
- 阶段2：3发导弹齐射
- 阶段3：超级导弹（追踪所有敌机）

### 8.3.3 环境互动武器

**雷电链**
- 在敌机间传导的连锁闪电
- 每次传导伤害递减20%
- 最多传导5次

**黑洞炮**
- 生成吸引敌机和子弹的重力场
- 持续3秒后爆炸
- 对Boss无吸引效果

**镜像分身**
- 生成2个分身协同攻击
- 分身继承50%攻击力
- 持续10秒

## 8.4 弹幕生成算法

### 8.4.1 基础弹幕模式

#### 直线弹幕
```javascript
// 参数定义
{
  发射点: {x, y},
  方向角度: θ (0-360°),
  子弹速度: v (像素/秒),
  发射间隔: interval (毫秒),
  子弹数量: count
}
```

**实现要点**
- 使用三角函数计算弹道方向
- 速度矢量分解为vx和vy
- 支持加速度和重力影响

#### 扇形弹幕
```javascript
// 参数定义
{
  发射点: {x, y},
  中心角度: θ_center,
  扇形角度: θ_spread,
  子弹数量: n,
  同时发射: simultaneous (bool),
  螺旋偏移: spiral_offset
}
```

**算法描述**
1. 计算每颗子弹的角度间隔：`θ_step = θ_spread / (n-1)`
2. 起始角度：`θ_start = θ_center - θ_spread/2`
3. 第i颗子弹角度：`θ_i = θ_start + i * θ_step`
4. 螺旋模式：每帧旋转基准角度

#### 环形弹幕
```javascript
// 参数定义
{
  中心点: {x, y},
  半径: r,
  子弹数量: n,
  旋转速度: ω (度/秒),
  扩散速度: v_expand,
  收缩模式: converge (bool)
}
```

**生成步骤**
1. 均匀分布：`θ_i = 360° * i / n`
2. 计算位置：`x_i = x + r * cos(θ_i)`, `y_i = y + r * sin(θ_i)`
3. 径向速度：向外扩散或向内收缩
4. 切向速度：实现旋转效果

### 8.4.2 高级弹幕模式

#### 螺旋弹幕
```javascript
// 阿基米德螺旋
{
  极坐标方程: r = a + b * θ,
  角速度: ω,
  线速度: v,
  螺距: pitch,
  方向: clockwise/counter-clockwise
}
```

**特点**
- 从中心向外螺旋展开
- 可调节螺旋紧密程度
- 支持多重螺旋叠加

#### 正弦波弹幕
```javascript
// 波形弹幕
{
  基准线: y = y_base,
  振幅: A,
  频率: f,
  相位: φ,
  波速: v_wave,
  子弹间距: spacing
}
```

**轨迹方程**
- y = y_base + A * sin(2πf * t + φ)
- x = x_start + v_wave * t

#### 贝塞尔曲线弹幕
```javascript
// 曲线弹幕
{
  控制点: [P0, P1, P2, P3],
  插值点数: n,
  速度曲线: speed_curve,
  加速度: acceleration
}
```

**计算方法**
1. 三次贝塞尔曲线：B(t) = (1-t)³P0 + 3(1-t)²tP1 + 3(1-t)t²P2 + t³P3
2. t从0到1均匀采样n个点
3. 每个采样点发射一颗子弹

### 8.4.3 组合弹幕模式

#### 弹幕序列
```javascript
// 时间轴定义
[
  {time: 0, pattern: "扇形", params: {...}},
  {time: 500, pattern: "环形", params: {...}},
  {time: 1000, pattern: "螺旋", params: {...}},
  {time: 1500, pattern: "组合", params: {...}}
]
```

**执行逻辑**
1. 按时间轴触发不同弹幕
2. 支持并行和串行执行
3. 可设置循环模式

#### 自适应弹幕
```javascript
// 根据玩家位置动态调整
{
  追踪模式: "预判/即时",
  预判时间: predict_time,
  扩散角度: spread_angle,
  密度调节: density_factor,
  难度系数: difficulty
}
```

**智能调整**
- 根据玩家移动速度调整预判
- 距离越近弹幕越密集
- 根据玩家技能等级调整难度

### 8.4.4 弹幕优化策略

#### 对象池管理
```javascript
// 子弹对象池
{
  池大小: 500,
  预分配策略: "动态扩展",
  回收条件: "出界/命中/超时",
  重置方法: resetBullet()
}
```

**性能优化**
1. 预创建子弹对象避免运行时分配
2. 使用位运算优化碰撞检测
3. 分区域管理减少检测数量
4. 视锥剔除不可见子弹

#### 渲染批处理
```javascript
// 批量渲染
{
  批次大小: 100,
  纹理图集: "bullets_atlas.png",
  着色器: "instanced_rendering",
  排序策略: "按纹理/按深度"
}
```

**优化技巧**
- 相同类型子弹一次绘制
- 使用Canvas离屏渲染
- 脏矩形局部更新
- GPU加速粒子系统

### 8.4.5 弹幕配置示例

#### Boss弹幕配置
```json
{
  "boss_phase_1": {
    "patterns": [
      {
        "type": "spiral",
        "arms": 4,
        "speed": 200,
        "interval": 100,
        "rotation": 2
      },
      {
        "type": "circle",
        "bullets": 36,
        "radius": 0,
        "expand_speed": 150
      }
    ],
    "duration": 5000,
    "repeat": true
  },
  "boss_phase_2": {
    "patterns": [
      {
        "type": "sine_wave",
        "amplitude": 100,
        "frequency": 2,
        "bullets_per_wave": 20
      },
      {
        "type": "homing",
        "count": 3,
        "delay": 1000,
        "turn_rate": 90
      }
    ],
    "duration": 8000
  }
}
```

#### 难度调节参数
```json
{
  "easy": {
    "bullet_speed_multiplier": 0.7,
    "bullet_count_multiplier": 0.6,
    "pattern_interval_multiplier": 1.5
  },
  "normal": {
    "bullet_speed_multiplier": 1.0,
    "bullet_count_multiplier": 1.0,
    "pattern_interval_multiplier": 1.0
  },
  "hard": {
    "bullet_speed_multiplier": 1.3,
    "bullet_count_multiplier": 1.5,
    "pattern_interval_multiplier": 0.8
  },
  "insane": {
    "bullet_speed_multiplier": 1.6,
    "bullet_count_multiplier": 2.0,
    "pattern_interval_multiplier": 0.6,
    "special_patterns_enabled": true
  }
}
```

## 8.5 武器平衡设计

### 8.5.1 DPS计算公式

```
基础DPS = (单发伤害 × 射速 × 命中率) / (1 + 过热惩罚)
实际DPS = 基础DPS × situational_modifier × skill_modifier
```

**影响因素**
- 敌机类型相性（装甲/护盾/能量）
- 距离衰减
- 暴击概率
- 连击加成

### 8.5.2 武器相克关系

| 武器类型 | 对小型机 | 对中型机 | 对大型机 | 对Boss | 对护盾 | 对装甲 |
|---------|---------|---------|---------|--------|--------|--------|
| 机枪 | 优秀 | 良好 | 较差 | 差 | 普通 | 普通 |
| 激光 | 良好 | 优秀 | 良好 | 良好 | 优秀 | 较差 |
| 导弹 | 较差 | 良好 | 优秀 | 优秀 | 较差 | 优秀 |
| 散弹 | 优秀 | 良好 | 普通 | 差 | 普通 | 良好 |
| 电浆 | 良好 | 良好 | 良好 | 普通 | 较差 | 优秀 |
| 脉冲 | 良好 | 普通 | 较差 | 差 | 优秀 | 较差 |

### 8.5.3 能量经济系统

#### 能量获取
- 基础回复：2点/秒
- 击杀奖励：小型机+5，中型+10，大型+20
- 能量道具：立即恢复50点
- 连击奖励：10连击+10点

#### 能量消耗平衡
- 持续型武器：消耗与输出成正比
- 爆发型武器：高消耗换取瞬间输出
- 必杀技：清空能量槽

## 总结

武器系统作为游戏的核心战斗机制，需要在易用性和深度之间找到平衡。通过丰富的武器类型、灵活的升级路径、华丽的弹幕效果，为玩家提供多样化的游戏体验。同时，合理的性能优化确保在移动设备上也能流畅运行。

### 关键实现要点
1. 使用对象池减少内存分配
2. 批量渲染提升绘制效率
3. 分层碰撞检测降低计算复杂度
4. 配置驱动便于平衡调整
5. 模块化设计支持扩展新武器

### 后续扩展方向
- 武器改装系统（配件、涂装）
- 武器技能树（被动技能）
- 联机对战武器平衡
- 随机武器生成系统
- 武器交易市场
