<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全民飞机大战</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Microsoft YaHei', sans-serif;
            position: relative;
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: linear-gradient(to bottom, #001a33, #003366);
        }
        #debugInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0f0;
            font-size: 12px;
            font-family: monospace;
            background: rgba(0,0,0,0.7);
            padding: 5px;
            display: none;
            z-index: 1000;
        }
        #debugInfo.show {
            display: block;
        }
        
        /* 开始按钮样式 */
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 60px;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid #FFD700;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
            z-index: 100;
            animation: pulse 2s infinite;
        }
        
        #startButton:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.8);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        #startButton:active {
            transform: translate(-50%, -50%) scale(0.95);
        }
        
        #startButton.hidden {
            display: none;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            }
            50% {
                box-shadow: 0 4px 25px rgba(255, 215, 0, 0.8);
            }
            100% {
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            }
        }
        
        /* 控制提示 */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #888;
            font-size: 14px;
            text-align: center;
            z-index: 50;
        }
        
        #controls.hidden {
            display: none;
        }
        
        /* 音频控制面板 */
        #audioControls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            color: white;
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            z-index: 100;
            min-width: 200px;
        }
        
        #audioControls h3 {
            margin: 0 0 10px 0;
            color: #FFD700;
            font-size: 16px;
            text-align: center;
        }
        
        .audio-control {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .audio-control label {
            color: #00FF00;
            margin-right: 10px;
        }
        
        .audio-control input[type="range"] {
            width: 100px;
            cursor: pointer;
        }
        
        .audio-control span {
            color: #FFD700;
            min-width: 40px;
            text-align: right;
        }
        
        .audio-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        
        .audio-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.5);
        }
        
        .audio-button.muted {
            background: linear-gradient(135deg, #FF6B6B 0%, #C44569 100%);
        }
        
        #audioControls.hidden {
            display: none;
        }
        
        .keyboard-hint {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #444;
            font-size: 12px;
            color: #888;
        }
        
        .keyboard-hint div {
            margin: 3px 0;
        }
        
        .key {
            color: #FFD700;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" tabindex="0"></canvas>
    <div id="debugInfo"></div>
    
    <!-- 开始按钮 -->
    <button id="startButton">开始游戏</button>
    
    <!-- 暂停按钮（游戏中显示） -->
    <button id="pauseButton" class="hidden" style="
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        font-size: 16px;
        background: rgba(0,0,0,0.7);
        color: #FFD700;
        border: 2px solid #FFD700;
        border-radius: 5px;
        cursor: pointer;
        z-index: 100;
    ">暂停</button>
    
    <!-- 控制提示 -->
    <div id="controls">
        <p>方向键/WASD: 移动 | 1/2/3: 切换战机 | Tab: 切换武器 | 空格: 炸弹</p>
        <p>ESC: 暂停 | F3: 调试模式 | M: 静音 | -/+: 音量</p>
    </div>
    
    <!-- 音频控制面板 -->
    <div id="audioControls">
        <h3>🎵 音频控制</h3>
        
        <div class="audio-control">
            <label>音乐:</label>
            <input type="range" id="musicVolume" min="0" max="100" value="50">
            <span id="musicVolumeText">50%</span>
        </div>
        
        <div class="audio-control">
            <label>音效:</label>
            <input type="range" id="sfxVolume" min="0" max="100" value="50">
            <span id="sfxVolumeText">50%</span>
        </div>
        
        <button id="muteButton" class="audio-button">静音</button>
        
        <div class="keyboard-hint">
            <div><span class="key">M</span> - 静音切换</div>
            <div><span class="key">-/+</span> - 音量调节</div>
        </div>
    </div>
    
    <script src="js/core/GameConfig.js"></script>
    <script src="js/core/GameLoop.js"></script>
    <script src="js/core/StateMachine.js"></script>
    <script src="js/assets/AssetManager.js"></script>
    <script src="js/render/Renderer.js"></script>
    <script src="js/input/InputManager.js"></script>
    <script src="js/entities/Player.js"></script>
    <script src="js/entities/Enemy.js"></script>
    <script src="js/combat/Weapon.js"></script>
    <script src="js/combat/BulletSystem.js"></script>
    <script src="js/combat/CollisionSystem.js"></script>
    <script src="js/effects/ParticleSystem.js"></script>
    <script src="js/audio/AudioManager.js"></script>
    <!-- Phase 3: Level Content -->
    <script src="js/levels/LevelManager.js"></script>
    <script src="js/levels/WaveManager.js"></script>
    <script src="js/boss/Boss.js"></script>
    <script src="js/boss/BossManager.js"></script>
    <script src="js/powerups/PowerUp.js"></script>
    <script src="js/powerups/PowerUpManager.js"></script>
    <script src="js/Game.js"></script>
    <script>
        let game;
        
        // 游戏初始化
        window.addEventListener('DOMContentLoaded', () => {
            game = new Game();
            game.init();
            game.start();
            
            // 获取元素
            const startButton = document.getElementById('startButton');
            const pauseButton = document.getElementById('pauseButton');
            const controls = document.getElementById('controls');
            
            // 开始按钮点击事件
            startButton.addEventListener('click', () => {
                // 隐藏按钮和提示
                startButton.classList.add('hidden');
                controls.classList.add('hidden');
                
                // 根据当前文字决定行为
                if (startButton.textContent === '重新开始') {
                    game.player.reset();
                    game.stateMachine.changeState(GameConfig.STATES.MENU);
                    startButton.textContent = '开始游戏';
                } else {
                    // 切换到游戏状态
                    game.stateMachine.changeState(GameConfig.STATES.PLAYING);
                }
                
                // 聚焦画布以接收键盘输入
                document.getElementById('gameCanvas').focus();
            });
            
            // 暂停按钮点击事件
            pauseButton.addEventListener('click', () => {
                const currentState = game.stateMachine.getCurrentStateName();
                if (currentState === GameConfig.STATES.PLAYING) {
                    game.stateMachine.changeState(GameConfig.STATES.PAUSED);
                    pauseButton.textContent = '继续';
                } else if (currentState === GameConfig.STATES.PAUSED) {
                    game.stateMachine.changeState(GameConfig.STATES.PLAYING);
                    pauseButton.textContent = '暂停';
                }
                document.getElementById('gameCanvas').focus();
            });
            
            // 监听状态变化，显示/隐藏按钮
            game.stateMachine.onStateChange((newState) => {
                if (newState === GameConfig.STATES.MENU) {
                    startButton.textContent = '开始游戏';
                    startButton.classList.remove('hidden');
                    controls.classList.remove('hidden');
                    pauseButton.classList.add('hidden');
                } else if (newState === GameConfig.STATES.PLAYING) {
                    startButton.classList.add('hidden');
                    controls.classList.add('hidden');
                    pauseButton.classList.remove('hidden');
                    pauseButton.textContent = '暂停';
                } else if (newState === GameConfig.STATES.PAUSED) {
                    pauseButton.textContent = '继续';
                } else if (newState === GameConfig.STATES.GAME_OVER) {
                    // 游戏结束时显示重新开始按钮
                    startButton.textContent = '重新开始';
                    startButton.classList.remove('hidden');
                    pauseButton.classList.add('hidden');
                }
            });
            
            // 音频控制初始化
            const musicVolumeSlider = document.getElementById('musicVolume');
            const musicVolumeText = document.getElementById('musicVolumeText');
            const sfxVolumeSlider = document.getElementById('sfxVolume');
            const sfxVolumeText = document.getElementById('sfxVolumeText');
            const muteButton = document.getElementById('muteButton');
            
            // 音乐音量控制
            musicVolumeSlider.addEventListener('input', (e) => {
                const volume = e.target.value / 100;
                if (window.audioManager) {
                    window.audioManager.setMusicVolume(volume);
                    musicVolumeText.textContent = `${e.target.value}%`;
                }
            });
            
            // 音效音量控制
            sfxVolumeSlider.addEventListener('input', (e) => {
                const volume = e.target.value / 100;
                if (window.audioManager) {
                    window.audioManager.setSfxVolume(volume);
                    sfxVolumeText.textContent = `${e.target.value}%`;
                }
            });
            
            // 静音按钮
            muteButton.addEventListener('click', () => {
                if (window.audioManager) {
                    const muted = window.audioManager.toggleMute();
                    muteButton.textContent = muted ? '取消静音' : '静音';
                    muteButton.classList.toggle('muted', muted);
                }
            });
            
            // 统一的键盘事件处理器 - 所有键盘输入的单一入口
            window.addEventListener('keydown', (e) => {
                // 获取当前游戏状态
                const isPlaying = game && game.stateMachine && 
                    game.stateMachine.getCurrentStateName() === GameConfig.STATES.PLAYING;
                
                // 优先处理UI控制（这些在任何状态下都应该工作）
                
                // 音量控制快捷键
                if (e.key === 'm' || e.key === 'M') {
                    muteButton.click();
                    return;
                } else if (e.key === '-' || e.key === '_') {
                    const currentVolume = parseInt(musicVolumeSlider.value);
                    const newVolume = Math.max(0, currentVolume - 10);
                    musicVolumeSlider.value = newVolume;
                    sfxVolumeSlider.value = newVolume;
                    musicVolumeSlider.dispatchEvent(new Event('input'));
                    sfxVolumeSlider.dispatchEvent(new Event('input'));
                    return;
                } else if (e.key === '=' || e.key === '+') {
                    const currentVolume = parseInt(musicVolumeSlider.value);
                    const newVolume = Math.min(100, currentVolume + 10);
                    musicVolumeSlider.value = newVolume;
                    sfxVolumeSlider.value = newVolume;
                    musicVolumeSlider.dispatchEvent(new Event('input'));
                    sfxVolumeSlider.dispatchEvent(new Event('input'));
                    return;
                }
                
                // 调试模式切换
                if (e.key === 'F3') {
                    e.preventDefault();
                    document.getElementById('debugInfo').classList.toggle('show');
                    return;
                }
                
                // Enter键快速开始（仅在菜单时）
                if (e.key === 'Enter' && !startButton.classList.contains('hidden')) {
                    startButton.click();
                    return;
                }
                
                // 游戏进行中的控制
                if (isPlaying && game) {
                    // 战机切换 (1/2/3)
                    if (e.key === '1') {
                        console.log('切换到战斗机');
                        game.switchAircraft('fighter');
                        e.preventDefault();
                    } else if (e.key === '2') {
                        console.log('切换到轰炸机');
                        game.switchAircraft('bomber');
                        e.preventDefault();
                    } else if (e.key === '3') {
                        console.log('切换到拦截机');
                        game.switchAircraft('interceptor');
                        e.preventDefault();
                    } 
                    // 空格键放炸弹
                    else if (e.key === ' ' || e.code === 'Space') {
                        console.log('使用炸弹');
                        game.triggerBomb();
                        e.preventDefault();
                    }
                    // Tab切换武器
                    else if (e.key === 'Tab') {
                        console.log('切换武器');
                        if (game.player && game.player.weaponManager) {
                            game.player.weaponManager.switchWeapon();
                            game.showMessage = `武器: ${game.player.weaponManager.getCurrentWeaponName()}`;
                            game.messageTimer = 60;
                        }
                        e.preventDefault();
                    }
                    // ESC暂停
                    else if (e.key === 'Escape') {
                        console.log('暂停游戏');
                        game.stateMachine.changeState(GameConfig.STATES.PAUSED);
                        e.preventDefault();
                    }
                    
                    // 移动控制仍由InputManager处理（因为需要持续按键检测）
                    // Arrow keys and WASD are handled by InputManager
                }
            });
        });
    </script>
</body>
</html>